---
output: 
  bookdown::html_document2:
    code_folding: show
---

# Clear Lake data wrangling {.tabset}

```{r message = F, warning = F, results = 'hide', echo = T}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, fig.path = 'figs/', dev.args = list(family = 'serif'))

library(tidyverse)
library(readxl)
library(lubridate)
library(here)
library(sf)
library(mapview)
```

## Biological results

Import raw data:

```{r}
biodatraw <- read_excel(here('data/raw', 'Refined Biological Results.xlsx'))
```

Select station, lat, lon, date, time, parameter, value, result, and units. Take unique values.

```{r}
# selecting lat, lon, date, time, parameter, value, result, unit
# taking unique values (making some assumptions)
biodat <- biodatraw %>%
  select(
    station = MonitoringLocationIdentifier,
    latitude = `ActivityLocation/LatitudeMeasure`,
    longitude = `ActivityLocation/LongitudeMeasure`,
    date = ActivityStartDate,
    time = `ActivityStartTime/Time`,
    param = `CharacteristicName`,
    val = ResultMeasureValue,
    unit = `ResultMeasure/MeasureUnitCode`
    ) %>%
  unique
```

Filter out parameters with few observations (less than 1000), include microcystin and chlorophyll. 

```{r}
biodat <- biodat %>%
  group_by(param) %>%
  mutate(
    n = n()
  ) %>%
  ungroup %>%
  filter(n > 1000 | grepl('^Microcystin|^Chloroph', param)) %>%
  select(-n)
```


Standardizing names for units.

```{r}
biodat <- biodat %>%
  mutate(
    unit = case_when(
      unit == '%' ~ '% saturatn',
      unit == 'ft/sec' ~ 'ft',
      unit == 'PSS' ~ 'ppt',  # these are equivalent
      unit == 'std units' ~ 'None', # for ph
      unit == 'uS/cm @25C' ~ 'uS/cm',
      grepl('Microcystin', param) & unit == 'ppb' ~ 'ug/l',
      T ~ unit
    )
  )
```


Remove turbidy as FTU, JTU, don't know what this is. Remove do sat as g/l. Remove conductance as degree c.

```{r}
biodat <- biodat %>%
  filter(!(unit %in% c('FTU', 'JTU') & param %in% 'Turbidity')) %>%
  filter(!(unit %in% 'g/l' & param %in% 'Dissolved oxygen saturation')) %>%
  filter(!(unit %in% 'deg C' & param %in% 'Specific conductance'))
```

Standardizing values for different units.

```{r}
biodat <- biodat %>%
  mutate(
    val = case_when(
      val %in% c('ND', 'TRACE') ~ 0,
      T ~ as.numeric(val)
      ),
    val = case_when(
      param == 'Depth, Secchi disk depth' & unit == 'ft' ~ val * 0.3048, # to m
      param == 'Iron' & unit == 'ug/l' ~ val * 0.001, # to mg/l
      param == 'Specific conductance' & unit == 'uS/cm' ~ val * 0.001, # to ms/cm
      param == 'deg F' ~ (val - 32) * 5 / 9 , # to deg C
      param == 'Total dissolved solids' & unit == 'tons/ac ft' ~ val * 0.735468, # to g/l
      param == 'Total dissolved solids' & unit == 'mg/l' ~ val * 0.001, # to g/l
      T ~ val
    ),
    unit = case_when(
      unit == 'ft' ~ 'm',
      param == 'Iron' & unit == 'ug/l' ~ 'mg/l',
      param == 'Specific conductance' & unit == 'uS/cm' ~ 'mS/cm',
      unit == 'deg F' ~ 'deg C',
      unit == 'tons/ac ft' ~ 'g/l',
      param == 'Total dissolved solids' & unit == 'mg/l' ~ 'g/l',
      T ~ unit
    )
  )

```

Final minor stuff, remove some values in param, take daily average of multiples. 

```{r}
biodat <- biodat %>%
  mutate(
    param = case_when(
      param == 'Chlorophyll a (probe)' ~ 'Chlorophyll a',
      T ~ param
    ),
    date = ymd(date)
  ) %>%
  select(-time) %>%
  group_by(station, date, param, unit) %>%
  summarise_all(mean, na.rm = T) %>%
  filter(!is.na(val))

head(biodat)
```

## Physical results

Similar process as above. 

```{r}
phydatraw <- read_excel(here('data/raw', 'Refined Physical Result.xlsx'))

# selecting station, date, time, parameter, value, result, unit
# taking unique values (making some assumptions)
phydat <- phydatraw %>%
  select(
    station = MonitoringLocationIdentifier,
    date = ActivityStartDate,
    time = `ActivityStartTime/Time`,
    param = `CharacteristicName`,
    val = ResultMeasureValue,
    unit = `ResultMeasure/MeasureUnitCode`
    ) %>%
  unique

# filtering out parameters with few observations, include microcystin and chlorophyll
phydat <- phydat %>%
  group_by(param) %>%
  mutate(
    n = n()
  ) %>%
  ungroup %>%
  filter(n > 1000 | grepl('^Microcystin|^Chloroph', param)) %>%
  select(-n)

# table(phydat[, c('param', 'unit')])

# standardizing names for units
phydat <- phydat %>%
  mutate(
    unit = case_when(
      unit == '%' ~ '% saturatn',
      unit == 'ft/sec' ~ 'ft',
      unit == 'PSS' ~ 'ppt',  # these are equivalent
      unit == 'std units' ~ 'None', # for ph
      unit == 'uS/cm @25C' ~ 'uS/cm',
      grepl('Microcystin', param) & unit == 'ppb' ~ 'ug/l',
      T ~ unit
    )
  )

# remove turbidy as FTU, JTU, don't know what this is
# remove do sat as g/l
# remove conductance as degree c
phydat <- phydat %>%
  filter(!(unit %in% c('FTU', 'JTU') & param %in% 'Turbidity')) %>%
  filter(!(unit %in% 'g/l' & param %in% 'Dissolved oxygen saturation')) %>%
  filter(!(unit %in% 'deg C' & param %in% 'Specific conductance'))

# table(biodat[, c('param', 'unit')])

# standardizing values for different units
phydat <- phydat %>%
  mutate(
    val = case_when(
      val %in% c('ND', 'TRACE') ~ 0,
      T ~ as.numeric(val)
      ),
    val = case_when(
      param == 'Depth, Secchi disk depth' & unit == 'ft' ~ val * 0.3048, # to m
      param == 'Iron' & unit == 'ug/l' ~ val * 0.001, # to mg/l
      param == 'Specific conductance' & unit == 'uS/cm' ~ val * 0.001, # to ms/cm
      param == 'deg F' ~ (val - 32) * 5 / 9 , # to deg C
      param == 'Total dissolved solids' & unit == 'tons/ac ft' ~ val * 0.735468, # to g/l
      param == 'Total dissolved solids' & unit == 'mg/l' ~ val * 0.001, # to g/l
      T ~ val
    ),
    unit = case_when(
      unit == 'ft' ~ 'm',
      param == 'Iron' & unit == 'ug/l' ~ 'mg/l',
      param == 'Specific conductance' & unit == 'uS/cm' ~ 'mS/cm',
      unit == 'deg F' ~ 'deg C',
      unit == 'tons/ac ft' ~ 'g/l',
      param == 'Total dissolved solids' & unit == 'mg/l' ~ 'g/l',
      T ~ unit
    )
  )

# final minor edits
# rename some values in param
# take daily avg for multiples
phydat <- phydat %>%
  mutate(
    param = case_when(
      param == 'Chlorophyll a (probe)' ~ 'Chlorophyll a',
      param == 'Microcystins' ~ 'Microcystin',
      T ~ param
    ),
    date = ymd(date)
  ) %>%
  select(-time) %>%
  group_by(station, date, param, unit) %>%
  summarise_all(mean, na.rm = T) %>%
  filter(!is.na(val))
```

```{r}
head(phydat)
```

## Join biology and physical results

[download](https://github.com/SCCWRP/ClearLakeRisk/raw/master/data/alldat.csv)

They are basically the same. 

```{r}
# join both
alldat <- biodat %>%
  full_join(phydat, c('station', 'date', 'param', 'unit', 'val'))

head(alldat)
```

## Flow data

[download](https://github.com/SCCWRP/ClearLakeRisk/raw/master/data/disdat.csv)

Import raw. 

```{r}
disdatraw <- read_excel(here('data/raw', 'Lake discharge.xlsx'), skip = 11)
```

Take daily average. 

```{r}
disdat <- disdatraw %>% 
  mutate(
    date = as.Date(Date)
  ) %>%  
  select(
    date, 
    discharge_cfs = `Dischage (cubic feet per second)`
  ) %>% 
  group_by(date) %>% 
  summarise(discharge_cfs = mean(discharge_cfs, na.rm = T))

head(disdat)
```

## Analysis

```{r}

# filter by station, parameter, all complete
tomod <- alldat %>% 
  filter(param %in% c('Microcystin', 'Chlorophyll a')) %>% 
  filter(station %in%  'CA_BVR-CLV7') %>% 
  select(-unit) %>% 
  spread(param, val) %>% 
  na.omit %>% 
  left_join(disdat, by = 'date') %>% 
  gather('param', 'val', `Chlorophyll a`, Microcystin, discharge_cfs)

ggplot(tomod, aes(x = date, y = val)) + 
  geom_line() + 
  geom_point() + 
  facet_wrap(~param, scales = 'free_y', ncol = 1)

``` 

## Map

```{r}
prj <- 4326

tomap <- alldat %>% 
  select(station, val, latitude, longitude) %>%
  group_by(station, latitude, longitude) %>% 
  summarise(n = n()) %>% 
  unique %>% 
  na.omit %>% 
  st_as_sf(coords = c('longitude', 'latitude'), crs = prj)

mapview(tomap, zcol = 'n')
```



